<template>
    <template if:false={isSaved}>
    <!-- Card for Funder Costing Details -->
    <div class="funderDetails">
    <lightning-card >
        
        <h1 class="custom-heading" >Funder Costing Details</h1>
        <template if:true={costingDetails}>
            <div class="slds-grid slds-wrap slds-p-around_small">
                <!-- Normal Bead -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="Normal Bead" 
                        data-field="Normal_Bead__c" 
                        onchange={handleNormalBeadChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.Normal_Bead__c}>
                        <span class="field-value">{costingDetails.Normal_Bead__c}</span>
                    </template>
                </div>

                <!-- Innovation Bead Checkbox, Hide when Normal Bead is checked -->
                <template if:false={isNormalBeadChecked}>
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <lightning-input 
                            type="checkbox" 
                            label="Innovation Bead" 
                            data-field="Innovation_Bead__c" 
                            checked
            onchange={handleInnovationBeadChange}>
                        </lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <template if:true={fieldVisibility.Innovation_Bead__c}>
                            <span class="field-value">{costingDetails.Innovation_Bead__c}</span>
                        </template>
                    </div>
                </template>

                <!-- RIR -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="RIR" 
                        data-field="RIR__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.RIR__c}>
                        <span class="field-value">{costingDetails.RIR__c}</span>
                    </template>
                </div>

                <!-- Loft -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="Loft" 
                        data-field="Loft__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.Loft__c}>
                        <span class="field-value">{costingDetails.Loft__c}</span>
                    </template>
                </div>

                <!-- Mechanical Vents -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="Mechanical Vents" 
                        data-field="Mechanical_Vents__c" 
                        onchange={handleMechanicalVentsChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.Mechanical_Vents__c}>
                        <lightning-input 
                            type="number" 
                            label="Mechanical Vents Quantity" 
                            value={mechanicalVents} 
                            onchange={handleMechanicalVentsValueChange}>
                        </lightning-input>
                        <strong>Mechanical Vents Cost: {totalMechanicalVentsCost}</strong>
                    </template>
                </div>

                <!-- EPR Fee -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="EPR Fee" 
                        data-field="EPR_fee__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.EPR_fee__c}>
                        <span class="field-value">{costingDetails.EPR_fee__c}</span>
                    </template>
                </div>

                <!-- EPC Elmhurst -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="EPC Elmhurst" 
                        data-field="EPC_Elmhurst__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.EPC_Elmhurst__c}>
                        <span class="field-value">{costingDetails.EPC_Elmhurst__c}</span>
                    </template>
                </div>

                <!-- TM Lodgement -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="TM Lodgement" 
                        data-field="TM_Lodgement__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.TM_Lodgement__c}>
                        <span class="field-value">{costingDetails.TM_Lodgement__c}</span>
                    </template>
                </div>

                <!-- TM Amendment -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="TM Amendment" 
                        data-field="TM_Amendment__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.TM_Amendment__c}>
                        <span class="field-value">{costingDetails.TM_Amendment__c}</span>
                    </template>
                </div>

                <!-- Survey Fee -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="Survey Fee" 
                        data-field="Survey_Fee__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.Survey_Fee__c}>
                        <span class="field-value">{costingDetails.Survey_Fee__c}</span>
                    </template>
                </div>

                <!-- Tech Survey -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="Tech Survey" 
                        data-field="Tech_Survey__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.Tech_Survey__c}>
                        <span class="field-value">{costingDetails.Tech_Survey__c}</span>
                    </template>
                </div>

                <!-- Retrofit Coordination -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="Retrofit Coordination" 
                        data-field="Retrofit_Coodintation__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.Retrofit_Coodintation__c}>
                        <span class="field-value">{costingDetails.Retrofit_Coodintation__c}</span>
                    </template>
                </div>

                <!-- Land Registry -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="Land Registry" 
                        data-field="Land_Registry__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.Land_Registry__c}>
                        <span class="field-value">{costingDetails.Land_Registry__c}</span>
                    </template>
                </div>

                <!-- CIGA Search -->
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <lightning-input 
                        type="checkbox" 
                        label="CIGA Search" 
                        data-field="CIGA_Search__c" 
                        onchange={handleCheckboxChange}>
                    </lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <template if:true={fieldVisibility.CIGA_Search__c}>
                        <span class="field-value">{costingDetails.CIGA_Search__c}</span>
                    </template>
                </div>
            </div> 
        </template>

        <template if:true={error}>
            <p>Error loading Funder Costing Details</p>
        </template>
    </lightning-card>
</div>
    <!-- Funder List and Summary Card -->
    <lightning-card >
        <h2 class="custom-heading1">Funder List</h2>
        <template if:true={funders.length}>
            <table class="slds-table slds-table_bordered slds-table_cell-buffer">
                <thead>
                    <tr class="slds-text-title_caps">
                        <th scope="col">
                            <div class="slds-truncate" title="Funder Name">Funder Name</div>
                        </th>
                        <th scope="col">
                            <div class="slds-truncate" title="Funder Price">Funder Price</div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <template for:each={funders} for:item="funder">
                        <tr key={funder.name}>
                            <td data-label="Funder Name">
                                <span>{funder.name}</span>
                            </td>
                            <td data-label="Funder Price">
                                <span>{funder.price}</span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </template>

        <template if:false={funders.length}>
            <p>No funders available</p>
        </template>

        <!-- Funder Details Section -->
         <div class="funderDetails">
        <div class="slds-grid slds-wrap slds-p-around_small">
            <!-- Funder Average Price -->
            <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                <strong>Funder average price:</strong>
            </div>
            <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                <span>{funderAveragePrice}</span>
            </div>

            <!-- ABS Costing -->
            <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                <strong>ABS Costing:</strong>
            </div>
            <!-- abs costing -->

            <template if:true={showLoading}>
                <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
            </template>
        
            <template if:true={showError}>
                <div class="slds-box slds-theme_error">
                    <p>Error loading SAP Band and Cost Savings: {errorMessage}</p>
                    <lightning-button label="Retry" onclick={handleRetry} variant="brand"></lightning-button>
                </div>
            </template>
        
            <template if:true={showData}>
                <div class="slds-box slds-theme_default">
                    <p><strong>Current SAP Band:</strong> {currentSAPBand}</p>
                    <p><strong>Potential SAP Band:</strong> {potentialSAPBand}</p>
                    <br><br>
                    <p><strong>Abs Costing:</strong> {costSavings}</p>
                </div>
            </template>

            <!-- <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                <span>{costSavings}</span>
            </div> -->

            <!-- Profit Bar -->
            <hr>

            <!-- Price We Get -->
            <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                <strong>Price We Get:</strong>
            </div>
            <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                <span>{priceWeGet}</span>
            </div>

            <!-- Total Cost -->
            <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                <strong>Total Cost:</strong>
            </div>
            <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                <span>{totalCost}</span>
            </div>

            <!-- Profit Amount -->
            <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                <strong>Profit Amount:</strong>
            </div>
            <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                <span>{profitAmount}</span>
            </div>

           
            <!-- update percentage bar -->

            
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <p>Profit Percent :</p>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                    <!-- Progress bar container -->
                    <div class="progress-container">
                        <!-- Progress bar, style dynamically applied based on percentageClass and percentageWidth -->
                        <div class={percentageClass} style="width: {percentageWidth};">
                            {profitPercentage} %
                        </div>
                    </div>
                </div>
            

        </div>
    </div>
        <!-- <div class="slds-col slds-size_1-of-1 slds-p-bottom_x-small">
            <div class="profit-bar" style="width: {profitBarWidth}; background-color: {profitBarColor}; height: 20px;"></div>
        </div> -->
        
        
        

        <!-- Save and Previous Buttons -->
         <div class="funderButton">
         <lightning-card>
        <div class="slds-col slds-size_1-of-1 slds-p-top_medium slds-float_left">
            <!-- <lightning-button label="Previous" onclick={handlePrevious}></lightning-button> &nbsp; &nbsp; -->
            <lightning-button label="Save" variant="brand" onclick={handleSave}></lightning-button>
        </div>
    </lightning-card>
</div>

        
    </lightning-card>
</template>

 


    <!-- Display Summary if isSummary is true -->
    <template if:true={isSummary} >
        
        <lightning-card>
            
                <h3 class="custom-message">
                    Costing has already been done.
                    <br />
                    Please click on "<strong>EDIT1</strong>" to continue.
                    <br />
                    Here are the values that were previously selected from the costing.
                </h3>
        
                <!-- Summary of fields -->
                 <!-- Show loading spinner -->
        <template if:true={isLoading}>
            <lightning-spinner alternative-text="Loading"></lightning-spinner>
        </template>
        <lightning-button class ="slds-float_right " label="Refresh" onclick={refreshCostingData}></lightning-button>
        <br><br>
        <!-- Show costing records once loaded -->
        <template if:true={costingRecords}>
            <div class="slds-grid slds-align_absolute-center slds-m-around_medium">
            <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                <thead>
                    <tr>
                        <th>Field</th>
                        <template for:each={costingRecords} for:item="record">
                            <!-- Use only record.Id as key -->
                            <th key={record.Id}>{record.Name}</th>
                        </template>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>Cavity Guarantee</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Cavity_Guarantee__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>CIGA Search</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.CIGA_Search__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>EPC Elmhurst</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.EPC_Elmhurst__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>EPR Fee</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.EPR_fee__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>EWI</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.EWI__c}</td>
                        </template>
                    </tr>
                    <!-- <tr>
                        <th>Funder</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Funder__c}</td>
                        </template>
                    </tr> -->
                    <tr>
                        <th>Innovation Bead</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Innovation_Bead__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>Land Registry</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Land_Registry__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>Loft</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Loft__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>Loft Guarantee</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Loft_Guarantee__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>Mechanical Vents</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Mechanical_Vents__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>Normal Bead</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Normal_Bead__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>Retrofit Coordination</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Retrofit_Coodintation__c}	</td>
                        </template>
                    </tr>
                    <tr>
                        <th>RIR</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.RIR__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>Survey Fee</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Survey_Fee__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>Tech Survey</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.Tech_Survey__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>TM Amendment</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.TM_Amendment__c}</td>
                        </template>
                    </tr>
                    <tr>
                        <th>TM Lodgement</th>
                        <template for:each={costingRecords} for:item="record">
                            <td key={record.Id}>{record.TM_Lodgement__c}</td>
                        </template>
                    </tr>
                </tbody>
            </table>
        </div>
        </template>

        <!-- Show error if there is an error -->
        <template if:true={error}>
            <p class="slds-text-color_error">Error: {error.body.message}</p>
        </template>

        <!-- summary field end here -->

                <div class="funderDetails">
                <!-- Financial Summary -->
                <div class="slds-grid slds-wrap slds-p-around_small financial-summary">
                    <!-- Funder Average Price -->
                    <div class="slds-col slds-size_1 slds-p-bottom_x-small">
                        <strong>Funder average price:</strong>
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <span>{funderAveragePrice}</span>
                    </div>
        
                    <!-- ABS Costing -->
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <strong>ABS Costing:</strong>
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <span>{costSavings}</span>
                    </div>
        
                    <!-- Price We Get -->
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <strong>Price We Get:</strong>
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <span>{priceWeGet}</span>
                    </div>
        
                    <!-- Total Cost -->
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <strong>Total Cost:</strong>
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <span>{totalCost}</span>
                    </div>
        
                    <!-- Profit Amount -->
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <strong>Profit Amount:</strong>
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <span>{profitAmount}</span>
                    </div>
        
                    
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <p>Profit Percent :</p>
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-bottom_x-small">
                        <!-- Progress bar container -->
                        <div class="progress-container">
                            <!-- Progress bar, style dynamically applied based on percentageClass and percentageWidth -->
                            <div class={percentageClass} style="width: {percentageWidth};">
                                {profitPercentage} %
                            </div>
                        </div>
                    </div>
                </div>
        
                <!-- Edit Button (to go back to editable mode) -->
                <div class ="slds-float_right">
                    <lightning-button label="Edit" variant="brand" onclick={handleEdit}></lightning-button>
                </div>
            </div>
        </lightning-card>
        
    </template>

     <!-- Success message and buttons after saving -->
    <template if:true={isFinish}>
        <lightning-card>
            <h2 class="custom-heading">Costing saved successfully.</h2>
            <div class="slds-p-around_medium">
                <!-- Finish Button (only displayed when saving is completed) -->
                <div class="funderButton">
                    <lightning-button label="FINISH" variant="brand" onclick={handleFinish}></lightning-button>
                </div>
            </div>
        </lightning-card>
    </template>


</template>


